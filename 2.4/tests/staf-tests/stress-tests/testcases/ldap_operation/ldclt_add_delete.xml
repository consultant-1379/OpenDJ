<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE stax SYSTEM "../../../shared/stax.dtd">
<!--
 ! CDDL HEADER START
 !
 ! The contents of this file are subject to the terms of the
 ! Common Development and Distribution License, Version 1.0 only
 ! (the "License").  You may not use this file except in compliance
 ! with the License.
 !
 ! You can obtain a copy of the license at
 ! trunk/opends/resource/legal-notices/OpenDS.LICENSE
 ! or https://OpenDS.dev.java.net/OpenDS.LICENSE.
 ! See the License for the specific language governing permissions
 ! and limitations under the License.
 !
 ! When distributing Covered Code, include this CDDL HEADER in each
 ! file and include the License file at
 ! trunk/opends/resource/legal-notices/OpenDS.LICENSE.  If applicable,
 ! add the following below this CDDL HEADER, with the fields enclosed
 ! by brackets "[]" replaced with your own identifying information:
 !      Portions Copyright [yyyy] [name of copyright owner]
 !
 ! CDDL HEADER END
 !
 !      Copyright 2009 Sun Microsystems, Inc.
 ! -->
<stax>

  <defaultcall function="ldclt_add_delete"/>

  <function name="ldclt_add_delete">

    <sequence>

      <block name="'ldclt-add-delete'">
      
        <sequence>
  
          <script>
            if not CurrentTestPath.has_key('group'):
              CurrentTestPath['group']='ldap_operation'
            CurrentTestPath['suite']=STAXCurrentBlock
          </script>
      
          <call function="'testSuite_Preamble'"/>

          <script>
            adddeleteLoop   = testsDuration / 10
            lowRange        = 100000
            highRange       = lowRange + numberOfEntries
            jvmLoop         = testsDuration / 1800 + 1
            jvmSleep        = 1800000
            baseDN          = 'ou=People,dc=com'
            ldcltDir        = '%s/ldclt_dir' % TMPDIR
            ldcltTemplate   = '%s/ldclt_add.template' % ldcltDir
          </script>
          
          <import machine="STAF_LOCAL_HOSTNAME"
            file="'%s/testcases/ldap_operation/ldap_operation_setup.xml' % TESTS_DIR"/>
          <call function="'ldap_operation_setup'"/>

          <testcase name="getTestCaseName('Preamble')">
            
            <sequence>

              <call function="'testCase_Preamble'"/>

              <message>
                'ldclt_add_delete: Delete %s on %s' \
                % (ldcltDir, STAF_CLIENT_HOSTNAME)
              </message>

              <call function="'deleteFolder'">
                {
                'location'   : STAF_CLIENT_HOSTNAME ,
                'foldername' : ldcltDir
                }
              </call>

              <message>
                'ldclt_add_delete: Create %s on %s' \
                % (ldcltDir, STAF_CLIENT_HOSTNAME)
              </message>

              <call function="'createFolder'">
                {
                'location'   : STAF_CLIENT_HOSTNAME ,
                'foldername' : ldcltDir
                }
              </call>

              <message>
                'ldclt_add_delete: Create ldclt template'
              </message>

              <call function="'MakeALdcltTemplate'">
                { 
                'templateFile'     : ldcltTemplate ,
                'templateLocation' : STAF_CLIENT_HOSTNAME
                }
              </call>

              <call function="'testCase_Postamble'"/>

            </sequence>

          </testcase>

          <testcase name="getTestCaseName('Run ldclt add')">
            
            <sequence>
              
              <call function="'testCase_Preamble'"/>

              <message>
                 'ldclt_add_delete: Run ldclt add'
              </message>

              <!--<timer duration="timerDuration">
                <sequence>-->
                  <parallel>
                    <block name="'ldclt-add-threads'">
                    <sequence>
                      
                      <message>
                        'ldclt_add_delete: add threads'
                      </message>

                      <script>
                        opt1 = '-e delayedstartup=1 -e object=%s' % ldcltTemplate
                        opt2 = '-e "rdn=uid:user.[C=INCRN(%s;%s;6)]"' \
                                % (lowRange, highRange)
                        opt3 = '-e add -N %s -I 68 -v -q' % adddeleteLoop
                        opts = '%s %s %s' % (opt1, opt2, opt3)
                      </script>

                      <call function="'ldclt'">
                      {
                      'location'       : STAF_CLIENT_HOSTNAME ,
                      'dsInstanceHost' : DIRECTORY_INSTANCE_HOST,
                      'dsInstanceDn'   : DIRECTORY_INSTANCE_DN ,
                      'dsInstancePswd' : DIRECTORY_INSTANCE_PSWD ,
                      'dsBaseDn'       : baseDN ,
                      'ldcltOptions'   : opts ,
                      'outputFile'     : 'ldclt_add.res' ,
                      'outputPath'     : ldcltDir
                      }
                      </call>
                      
                    </sequence>
                    </block>
                    <block name="'ldclt-delete-threads'">
                    <sequence>

                      <call function="'Sleep'">
                        { 'sleepForMilliSeconds'  : 120000 }
                      </call>

                      <message>
                        'ldclt_add_delete: delete threads'
                      </message>

                      <script>
                        opt1 = '-e delayedstartup=1'
                        opt2 = '-e delete,rdn=\"uid:user.[RNDN(%s;%s;6)]\"' \
                                % (lowRange, highRange)
                        opt3 = '-N %s -I 32 -v -q' % adddeleteLoop
                        opts = '%s %s %s' % (opt1, opt2, opt3)
                      </script>

                      <call function="'ldclt'">
                      {
                      'location'       : STAF_CLIENT_HOSTNAME ,
                      'dsInstanceHost' : DIRECTORY_INSTANCE_HOST,
                      'dsInstanceDn'   : DIRECTORY_INSTANCE_DN ,
                      'dsInstancePswd' : DIRECTORY_INSTANCE_PSWD ,
                      'dsBaseDn'       : baseDN ,
                      'ldcltOptions'   : opts ,
                      'outputFile'     : 'ldclt_delete.res' ,
                      'outputPath'     : ldcltDir
                      }
                      </call>
                      
                    </sequence>
                    </block>
                    <block name="'ldclt-jvm'">
                    <sequence>

                      <loop from="1" to="jvmLoop" var="loop">
                        <sequence>
                          <message>'LOOP %s on %s' % (loop, jvmLoop)</message>
                          
                          <message>
                            'ldclt_add_delete: save jvm information'
                          </message>

                          <call function="'ldapSearchWithScript'">
                            {
                            'location'       : STAF_REMOTE_HOSTNAME ,
                            'dsInstanceHost' : DIRECTORY_INSTANCE_HOST ,
                            'dsInstancePort' : DIRECTORY_INSTANCE_PORT ,
                            'dsInstanceDn'   : DIRECTORY_INSTANCE_DN ,
                            'dsInstancePswd' : DIRECTORY_INSTANCE_PSWD ,
                            'dsBaseDN'       : 'cn=JVM Memory Usage,cn=monitor',
                            'dsFilter'       : 'objectclass=*' ,
                            'expectedRC'     : 'noCheck' ,
                            'outputFile'     : 'jvm_add_delete_%s.out' % loop ,
                            'outputPath'     : remote.temp
                            }
                          </call>

                          <if expr="loop != jvmLoop">
                            <call function="'Sleep'">
                              { 'sleepForMilliSeconds'  : jvmSleep }
                            </call>
                          </if>
                        </sequence>
                      </loop>
                    </sequence>
                    </block>
                  </parallel>
              <!--</sequence>
              </timer>

              <script>timerRC = RC</script>

              <if expr="timerRC == 0">
                <sequence>
                  <message>'Timer exceeds %s' % timerDuration</message>
                  <tcstatus result="'fail'"/>
                </sequence>
              </if>-->

              <message>
                'Copy %s/ldclt_add.res from %s to %s on %s' \
                % (ldcltDir,STAF_CLIENT_HOSTNAME,logs.sut,STAXServiceMachine)
              </message>
              <call function="'copyFile'">
                {
                'location'   : STAF_CLIENT_HOSTNAME ,
                'srcfile'    : '%s/ldclt_add.res' % ldcltDir ,
                'destfile'   : '%s/ldclt_add.res' % logs.sut ,
                'remotehost' : STAXServiceMachine
                }
              </call>

              <message>
                'Copy %s/ldclt_delete.res from %s to %s on %s' \
                % (ldcltDir,STAF_CLIENT_HOSTNAME,logs.sut,STAXServiceMachine)
              </message>
              <call function="'copyFile'">
                {
                'location'   : STAF_CLIENT_HOSTNAME ,
                'srcfile'    : '%s/ldclt_delete.res' % ldcltDir ,
                'destfile'   : '%s/ldclt_delete.res' % logs.sut ,
                'remotehost' : STAXServiceMachine
                }
              </call>

              <call function="'testCase_Postamble'"/>

            </sequence>
            
          </testcase>


          <testcase name="getTestCaseName('Check server is still running')">

            <sequence>
              
              <call function="'testCase_Preamble'"/>

              <message>
                'ldclt_add_delete: Check server is still running on port %s' \
                % (DIRECTORY_INSTANCE_PORT)
              </message>

              <!--- Check that DS started -->
              <call function="'isAlive'">
                {
                'noOfLoops'        : 10 ,
                'noOfMilliSeconds' : 5000
                }
              </call>

              <call function="'testCase_Postamble'"/>

            </sequence>

          </testcase>

          <import machine="STAF_LOCAL_HOSTNAME"
            file="'%s/testcases/ldap_operation/ldap_operation_cleanup.xml' % (TESTS_DIR)"/>
          <call function="'ldap_operation_cleanup'">
            { 'suiteSuffix' : 'add_delete' }
          </call>

          <call function="'testSuite_Postamble'"/>
            
        </sequence>
       
      </block>
       
    </sequence>
      
  </function>

</stax>
